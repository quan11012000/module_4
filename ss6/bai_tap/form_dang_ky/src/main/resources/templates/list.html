<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout :: head">
    <title>Danh sách người dùng</title>
</head>
<body>
<header th:replace="layout :: header"></header>

<main class="container mt-4">

    <!-- Toast -->
    <div th:if="${message}" class="position-fixed top-0 start-50 translate-middle-x p-3 z-3">
        <div id="successToast" class="toast text-bg-success border-0" role="alert" data-bs-delay="3000">
            <div class="d-flex">
                <div class="toast-body" th:text="${message}">Thành công</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>
    <div th:if="${error}" class="position-fixed top-0 start-50 translate-middle-x p-3 z-3">
        <div id="errorToast" class="toast text-bg-danger border-0" role="alert" data-bs-delay="3000">
            <div class="d-flex">
                <div class="toast-body" th:text="${error}">Có lỗi xảy ra</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Danh sách người dùng</h2>
    </div>

    <form class="row mb-3" th:action="@{/users}" method="get">
        <div class="col-md-3">
            <input type="text" class="form-control" name="keyword" placeholder="Tìm theo tên..."
                   th:value="${keyword}">
        </div>
        <div class="col-md-3">
            <select class="form-select" name="sort" onchange="this.form.submit()">
                <option value="desc" th:selected="${sort == null or sort == 'desc'}">Mới nhất</option>
                <option value="asc" th:selected="${sort == 'asc'}">Cũ nhất</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-outline-secondary">Tìm kiếm</button>
        </div>
    </form>

    <table class="table table-bordered table-hover">
        <thead class="table-light text-center">
        <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Giới tính</th>
            <th>Địa chỉ</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${users.content}">
            <td th:text="${user.username}">user</td>
            <td th:text="${user.email}">email</td>
            <td th:text="${user.gender} ? 'Nam' : 'Nữ'">Nam</td>
            <td th:text="${user.address}">HCM</td>
            <td class="text-center">
                <a class="btn btn-info btn-sm" th:href="@{/users/{id}(id=${user.id})}">Xem</a>
                <a class="btn btn-warning btn-sm" th:href="@{/users/{id}/edit(id=${user.id})}">Sửa</a>
                <button class="btn btn-danger btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal"
                        th:attr="data-id=${user.id},data-name=${user.username}">
                    Xoá
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Pagination -->
    <nav>
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${!users.hasPrevious()} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/users(page=${users.number - 1}, sort=${sort}, keyword=${keyword})}">&laquo;</a>
            </li>

            <li class="page-item"
                th:each="i : ${#numbers.sequence(0, users.totalPages - 1)}"
                th:classappend="${i == users.number} ? 'active'">
                <a class="page-link"
                   th:href="@{/users(page=${i}, sort=${sort}, keyword=${keyword})}"
                   th:text="${i + 1}">1</a>
            </li>

            <li class="page-item" th:classappend="${!users.hasNext()} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/users(page=${users.number + 1}, sort=${sort}, keyword=${keyword})}">&raquo;</a>
            </li>
        </ul>
    </nav>

</main>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="deleteForm" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận xoá</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    Bạn có chắc chắn muốn xoá người dùng <strong id="modalUserName"></strong>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                    <button type="submit" class="btn btn-danger">Xoá</button>
                </div>
            </form>
        </div>
    </div>
</div>

<footer th:replace="layout :: footer"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const showToast = (id) => {
            const toastEl = document.getElementById(id);
            if (!toastEl) return;
            const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
            toast.show();
        };
        showToast('successToast');
        showToast('errorToast');

        const deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-id');
            const username = button.getAttribute('data-name');
            document.getElementById('modalUserName').textContent = username;
            document.getElementById('deleteForm').setAttribute('action', '/users/' + userId + '/delete');
        });
    });
</script>

</body>
</html>
