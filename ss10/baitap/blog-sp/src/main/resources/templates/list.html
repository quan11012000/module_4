<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Danh sách blog</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-4">
    <h2>Danh sách Blog</h2>

    <!-- FORM TÌM KIẾM + LỌC -->
    <form id="filterForm" class="row g-3 mb-4">
        <div class="col-md-4">
            <input type="text" name="keyword" class="form-control" placeholder="Từ khóa" th:value="${keyword}">
        </div>
        <div class="col-md-3">
            <select name="categoryId" class="form-select">
                <option value="0">-- Tất cả thể loại --</option>
                <option th:each="temp : ${categoryList}"
                        th:value="${temp.idType}"
                        th:text="${temp.nameType}"
                        th:selected="${categoryId == temp.idType}">
                </option>
            </select>
        </div>
        <div class="col-md-3">
            <select name="sort" class="form-select">
                <option value="desc" th:selected="${sort == 'desc'}">Mới nhất</option>
                <option value="asc" th:selected="${sort == 'asc'}">Cũ nhất</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Tìm</button>
        </div>
    </form>

    <!-- DANH SÁCH BLOG -->
    <div id="blogList">
        <div class="row" id="blogsContainer" th:fragment="blog-items">
            <div class="col-md-4 mb-4" th:each="blog : ${blogs.content}">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title" th:text="${blog.title}"></h5>
                        <p class="card-text" th:text="${#strings.abbreviate(blog.content, 100)}">Nội dung...</p>
                        <a th:href="@{'/blogs/' + ${blog.id}}" class="btn btn-sm btn-outline-info">Xem chi tiết</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- NÚT TẢI THÊM -->
        <div class="text-center mt-3" id="loadMoreContainer">
            <button class="btn btn-secondary" id="loadMoreBtn" th:if="${blogs.hasNext()}">Tải thêm</button>
        </div>
    </div>
</div>

<script>
    let currentPage = 0;

    $('#filterForm').submit(function (e) {
        e.preventDefault();
        currentPage = 0;
        $('#blogsContainer').html('');
        loadBlogs(true);
    });

    $('#loadMoreBtn').click(function () {
        currentPage++;
        loadBlogs(false);
    });

    function loadBlogs(isNewSearch) {
        const formData = $('#filterForm').serialize();
        $.ajax({
            url: '/blogs/search?page=' + currentPage + '&' + formData,
            method: 'GET',
            success: function (data) {
                if (data.content.length === 0 && currentPage === 0) {
                    $('#blogsContainer').html('<p>Không có kết quả.</p>');
                    $('#loadMoreBtn').hide();
                    return;
                }

                data.content.forEach(function (blog) {
                    $('#blogsContainer').append(`
            <div class="col-md-4 mb-4">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">${blog.title}</h5>
                  <p class="card-text">${blog.content.substring(0, 100)}...</p>
                  <a href="/blogs/${blog.id}" class="btn btn-sm btn-outline-info">Xem chi tiết</a>
                </div>
              </div>
            </div>
          `);
                });

                if (data.last) {
                    $('#loadMoreBtn').hide();
                } else {
                    $('#loadMoreBtn').show();
                }
            },
            error: function () {
                alert('Đã xảy ra lỗi khi tải dữ liệu.');
            }
        });
    }
</script>

</body>
</html>
